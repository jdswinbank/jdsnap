#!/usr/bin/env python

import argparse
import json
import os.path
import shutil

import typing

from jdsnap import manage_all_archives
from jdsnap.types import ArchiveConfigurations


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Automated backups.")
    parser.add_argument("--tarsnap", default=shutil.which("tarsnap"))
    parser.add_argument(
        "--config",
        type=argparse.FileType(),
        default=os.path.expanduser("~/.jdsnap.json"),
    )
    parser.add_argument("--debug", action="store_true")
    return parser.parse_args()


def read_config(cfg_file: typing.TextIO) -> ArchiveConfigurations:
    return json.load(cfg_file)


def main() -> None:
    args = parse_args()
    archives = read_config(args.config)
    manage_all_archives(archives, args.tarsnap, args.debug)


if __name__ == "__main__":
    main()
